<div class="col-sm-9 col-sm-offset-3 col-md-10 col-md-offset-2 main">
    <div class="title page-header">
        <div class="right">
            <button class="btn btn-success" onclick="menuPage.save();" type="button">添加菜单</button>
        </div>
        <h1>菜单查询</h1>
    </div>
    <h2 class="sub-header">查询结果</h2>
    <div class="table-responsive">
        <table id="tableResult" data-pagination="true" data-side-pagination="server" data-striped="true" data-cache="false"
               data-unique-id="id" data-pagination-pre-text="上一页" data-pagination-next-text="下一页"></table>
    </div>
    <div id="deleteConfimModal"></div>
    <div class="modal fade" id="menuMaintainModal" role="dialog" aria-labelledby="myModalLabel">
        <div class="modal-dialog modal-ux" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                    <h4 class="modal-title" id="myModalLabel">菜单维护</h4>
                </div>
                <form action="javascript:menuPage.submit();">
                    <div class="modal-body">
                        <div class="form-group">
                            <div class="col-sm-12 input-group">
                                <span class="input-group-addon">菜单名称</span>
                                <input id="menuName" type="text" class="form-control" required/>
                            </div>
                            <div class="col-sm-12 input-group" style="margin-top: 15px;">
                                <span class="input-group-addon">菜单所属站点：</span>
                                <select id="menuStationId" type="text" class="form-control"></select>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer" style="text-align: center">
                        <input type="submit" class="btn btn-primary" value="提交"/>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
<script>
    var menuPage = {};
    (function (page) {
        function searchTableDatas() {
            $('#tableResult').bootstrapTable({
                url: 'api/merchant/menu/all',
                method: "get",
                contentType: "application/x-www-form-urlencoded",
                queryParams: function (params) {
                    return {pageSize: params.limit, pageNumber: params.offset / params.limit};
                },
                columns: [
                    {
                        title: '序号', align: "center",
                        formatter: function (value, row, index) {
                            return index + 1;
                        }
                    },
                    {title: '菜单名称', field: 'name'},
                    {
                        title: '所属站点', field: 'stationId',
                        formatter: function (value, row, index) {
                            return Enumerable.from(_stations).firstOrDefault(function (n) {
                                return n.id === row.stationId;
                            }, {name:"<span style='color:red'>无匹配站点</span>"}).name;
                        }
                    },
                    {title: '修改时间', field: 'modifyTime'},
                    {
                        title: '状态', field: 'isActive',
                        formatter: function (value, row, index) {
                            return '<input id="isActiveChk' + index + '" value="' + row.id + '" type="checkbox" ' + (row.isActive ? "checked" : "") + ' data-on-color="success" data-off-color="danger"/>';
                        }
                    },
                    {
                        title: '操作', field: 'id', formatter: function (value, row, index) {
                            var html = '<button type="button" class="btn btn-warning" onclick="menuPage.edit(' + value + ');"><span class="glyphicon glyphicon-pencil" aria-hidden="true"></span>修改</button>';
                            html += ' <button type="button" class="btn btn-danger" onclick="menuPage.delete(' + value + ');"><span class="glyphicon glyphicon-remove" aria-hidden="true"></span>删除</button>';
                            return html;
                        }
                    }
                ],
                onLoadSuccess: function (data) {
                    for (var i = 0; i < data.rows.length; i++) {
                        $("#isActiveChk" + i).bootstrapSwitch('state', data.rows[i].isActive).on("switchChange.bootstrapSwitch", function (event, status) {
                            changeActiveStatus(event.target.value, status);
                        });
                    }
                }
            });
        };

        var _stations = [];
        var _maintainType = "";
        var _maintainData = {};

        function submitMaintainRequest(param) {
            $.ajax({
                type: "POST", url: "api/merchant/menu",
                data: JSON.stringify(param), contentType: "application/json",
                success: function (result) {
                    if (result.status === SUCCESS) {
                        $("#tableResult").bootstrapTable("refresh", {silent: true});
                        $("#menuMaintainModal").modal("hide");
                    }
                }
            });
        }

        page.submit = function () {
            switch (_maintainType) {
                case "new":
                    var param = {name: $("#menuName").val(), stationId: $("#menuStationId").val()};
                    submitMaintainRequest(param);
                    break;
                case "edit":
                    _maintainData.name = $("#menuName").val();
                    _maintainData.stationId = $("#menuStationId").val();
                    submitMaintainRequest(_maintainData);
                    break;
            }
        };

        page.save = function (id) {
            $("#menuMaintainModal").modal("show");
            _maintainType = "new";
            $("#menuName").val("");
        };

        page.edit = function (id) {
            _maintainData = $("#tableResult").bootstrapTable("getRowByUniqueId", id);
            $("#menuMaintainModal").modal("show");
            _maintainType = "edit";
            $("#menuName").val(_maintainData.name);
        };

        page.delete = function (id) {
            deleteConfirmModal.showModal();
            deleteConfirmModal.bindDeleteAction(deleteMenu, id);
        };

        function deleteMenu(id) {
            $.ajax({
                type: "DELETE", url: "api/merchant/menu/" + id,
                data: {},
                success: function (result) {
                    $("#tableResult").bootstrapTable("refresh", {silent: true});
                }
            });
        }

        function changeActiveStatus(id, status) {
            $.ajax({
                type: "PUT", url: "api/merchant/menu/changeActiveStatus",
                data: {id: id, isActive: status},
                success: function (result) {
                    $("#tableResult").bootstrapTable("refresh", {silent: true});
                }
            });
        }

        function initStationSelect() {
            $.ajax({
                type: "get", url: "api/merchant/station/all",
                data: {pageNumber: 0, pageSize: 100}, async: false,
                success: function (result) {
                    _stations = result.rows;

                    var select = $("#menuStationId");
                    for (var i = 0; i < result.rows.length; i++) {
                        select.append('<option value="' + result.rows[i].id + '">' + result.rows[i].name + '</option>');
                    }
                }
            });
        }

        $(function () {
            initStationSelect();
            searchTableDatas();
            $("#deleteConfimModal").load("deleteConfirmModal.html");
        });
    })(menuPage);
</script>