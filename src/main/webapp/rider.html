<style>
    #activeSelect li.active a {color: #fff; background-color: #2F9D32}
</style>
<div class="col-sm-9 col-sm-offset-3 col-md-10 col-md-offset-2 main">
    <div class="title page-header">
        <h1>骑手信息查询</h1>
    </div>
    <div class="row placeholders">
        <div class="col-xs-6 col-sm-4 placeholder">
            <ul id="activeSelect" class="nav nav-pills">
                <li role="presentation" class="active" data-value="">
                    <a href="javascript:void(0);" onclick="riderPage.selectActiveStatus(0);">全部骑手&nbsp;(<span id="totalRiderCount"></span>)</a></li>
                <li role="presentation" data-value="未审核">
                    <a href="javascript:void(0);" onclick="riderPage.selectActiveStatus(1);">未审核&nbsp;(<span id="noApprovalRiderCount"></span>)</a>
                </li>
                <li role="presentation" data-value="审核通过">
                    <a href="javascript:void(0);" onclick="riderPage.selectActiveStatus(2);">审核通过&nbsp;(<span id="approvaledRiderCount"></span>)</a>
                </li>
                <li role="presentation" data-value="审核未通过">
                    <a href="javascript:void(0);" onclick="riderPage.selectActiveStatus(3);">审核未通过&nbsp;(<span id="notPassedRiderCount"></span>)</a>
                </li>
            </ul>
        </div>
        <div class="clearfix"></div>
        <div class="col-xs-6 col-sm-4 placeholder">
            <div class="input-group">
                <span class="input-group-addon">骑手姓名</span>
                <input id="riderName" onkeyup="riderPage.onEnterKeyPress()" class="form-control"
                       data-toggle="tooltip" data-placement="bottom" title="输入内容，点击键盘Enter查询"/>
            </div>

        </div>
        <div class="col-xs-6 col-sm-4 placeholder">
            <div class="input-group">
                <span class="input-group-addon">配送区域</span>
                <select id="stationSelect" onchange="riderPage.refreshTableDatas();" class="form-control"></select>
            </div>
        </div>
    </div>
    <h2 class="sub-header">查询结果</h2>
    <div class="table-responsive">
        <table id="tableResult" data-pagination="true" data-side-pagination="server" data-striped="true" data-cache="false"
               data-unique-id="id" data-pagination-pre-text="上一页" data-pagination-next-text="下一页"></table>
    </div>
</div>
<script>
    var riderPage = {};

    (function (page) {
        page.refreshTableDatas = function () {
            $('#tableResult').bootstrapTable("refresh", {silent: true});
        };

        page.selectActiveStatus = function (index) {
            var activeSelects = $("#activeSelect li");
            activeSelects.removeClass("active");
            activeSelects.eq(index).addClass("active");
            page.refreshTableDatas();
        };

        function initStations() {
            $.ajax({
                type: "get", url: "api/merchant/station/all",
                data: {pageNumber: 0, pageSize: 100}, async: false,
                success: function (result) {
                    var select = $("#stationSelect");
                    select.append('<option value="">全部</option>');
                    for (var i = 0; i < result.rows.length; i++) {
                        select.append('<option value="' + result.rows[i].id + '">' + result.rows[i].name + '</option>');
                    }
                }
            });
        }

        page.onEnterKeyPress = function () {
            var code = event.charCode || event.keyCode;
            if (code == 13) {
                page.refreshTableDatas();
            }
        };

        function initRiderCount() {
            $.ajax({
                type: "get", url: "api/merchant/rider/riderCount",
                data: {},
                success: function (result) {
                    $("#totalRiderCount").html(result.totalRiderCount);
                    $("#noApprovalRiderCount").html(result.noApprovalRiderCount);
                    $("#approvaledRiderCount").html(result.approvaledRiderCount);
                    $("#notPassedRiderCount").html(result.notPassedRiderCount);
                }
            });
        }

        function searchTableDatas() {
            $('#tableResult').bootstrapTable({
                url: 'api/merchant/rider/searchRiderForMixiConsole',
                method: "get",
                contentType: "application/x-www-form-urlencoded",
                queryParams: function (params) {
                    return {
                        pageSize: params.limit, pageNumber: params.offset / params.limit,
                        name: $("#riderName").val(), stationId: $("#stationSelect").val(),
                        approvalStatus: $("#activeSelect li.active").attr("data-value")
                    };
                },
                columns: [
                    {
                        title: '序号', align: "center",
                        formatter: function (value, row, index) {
                            return index + 1;
                        }
                    },
                    {title: '姓名', field: 'name'},
                    {title: '手机号码', field: 'phoneNumber'},
                    {title: '性别', field: 'sex'},
                    {title: '配送区域', field: 'station.name'},
                    {title: '职称', field: 'jobTitle'},
                    {title: '提交时间', field: 'creationTime'},
                    {title: '审核状态', field: 'approvalStatus'},
                    {
                        title: '启用状态', field: 'isActive',
                        formatter: function (value, row, index) {
                            return '<input id="isActiveChk' + index + '" value="' + row.id + '" type="checkbox" ' + (row.isActive ? "checked" : "") + ' data-on-color="success" data-off-color="default"/>';
                        }
                    },
                    {
                        title: '操作', field: 'id', formatter: function (value, row, index) {
                            var html = "";
                            if (row.approvalStatus === "未审核") {
                                html = '<span style="cursor: pointer;color:#2F9D32;" onclick="riderPage.showDetail(' + value + ');">【审批】</span>';
                            }
                            html += '<span style="cursor: pointer;color:#2F9D32;" onclick="riderPage.showDetail(' + value + ');">【查看详情】</span>';
                            html += '<span style="cursor: pointer;color:#2F9D32;" onclick="riderPage.delete(' + value + ');">【删除】</span>';
                            return html;
                        }
                    }
                ],
                onLoadSuccess: function (data) {
                    for (var i = 0; i < data.rows.length; i++) {
                        $("#isActiveChk" + i).bootstrapSwitch('state', data.rows[i].isActive).on("switchChange.bootstrapSwitch", function (event, status) {
                            changeActiveStatus(event.target.value, status);
                        });
                    }
                }
            });

        };

        function changeActiveStatus(id, status) {
            $.ajax({
                type: "PUT", url: "api/merchant/rider/changeActiveStatus",
                data: {id: id, isActive: status},
                success: function (result) {
                    if (result.status === SUCCESS) {
                        page.refreshTableDatas();
                    }
                }
            });
        }

        page.showDetail = function (id) {
            var currentData = $("#tableResult").bootstrapTable("getRowByUniqueId", id);
            indexPage.setContentBody("riderApproval.html", function (response, status, xhr) {
                riderApprovalPage.initData(currentData);
            });
        };

        page.delete = function (id) {
            deleteConfirmModal.showModal();
            deleteConfirmModal.bindDeleteAction(deleteRider, id);
        };

        function deleteRider(id) {
            $.ajax({
                type: "DELETE", url: "api/merchant/rider/" + id,
                data: {},
                success: function (result) {
                    if (result.status === SUCCESS)
                        $("#tableResult").bootstrapTable("refresh", {silent: true});
                    else
                        commonModal.showModal(result.data);
                }
            });
        }

        $(function () {
            $("#riderName").tooltip();
            searchTableDatas();
            initRiderCount();
            initStations();
        });
    })
    (riderPage);
</script>