<style>
    #activeSelect li.active a {
        color: #fff;
        background-color: #2F9D32
    }
</style>
<div class="col-sm-9 col-sm-offset-3 col-md-10 col-md-offset-2 main">
    <div class="title page-header">
        <h1>订单</h1>
    </div>
    <div class="row placeholders">
        <div class="col-xs-12 col-sm-12 placeholder">
            <ul id="activeSelect" class="nav nav-pills">
                <li role="presentation" class="active" data-value="">
                    <a href="javascript:void(0);" onclick="orderPage.selectOrderStatus(0);">全部订单(<span
                            id="totalCount"></span>)</a>
                </li>
                <li role="presentation" data-value="新订单" style="margin-left: 15px;">
                    <a href="javascript:void(0);" onclick="orderPage.selectOrderStatus(1);">新订单(<span
                            id="newCount"></span>)</a>
                </li>
                <li role="presentation" data-value="进行中" style="margin-left: 15px;">
                    <a href="javascript:void(0);" onclick="orderPage.selectOrderStatus(2);">进行中(<span
                            id="onGoingCount"></span>)</a>
                </li>
                <li role="presentation" data-value="已完成" style="margin-left: 15px;">
                    <a href="javascript:void(0);" onclick="orderPage.selectOrderStatus(3);">已完成(<span
                            id="completedCount"></span>)</a>
                </li>
                <li role="presentation" data-value="配送异常" style="margin-left: 15px;">
                    <a href="javascript:void(0);" onclick="orderPage.selectOrderStatus(4);">配送异常(<span
                            id="exceptionCount"></span>)</a>
                </li>
                <li role="presentation" data-value="催单" style="margin-left: 15px;">
                    <a href="javascript:void(0);" onclick="orderPage.selectOrderStatus(5);">催单(<span
                            id="pressedCount"></span>)</a>
                </li>
                <li role="presentation" data-value="取消订单" style="margin-left: 15px;">
                    <a href="javascript:void(0);" onclick="orderPage.selectOrderStatus(6);">取消订单(<span
                            id="cancelCount"></span>)</a>
                </li>
                <li role="presentation" data-value="退单" style="margin-left: 15px;">
                    <a href="javascript:void(0);" onclick="orderPage.selectOrderStatus(7);">退单(<span
                            id="returnedCount"></span>)</a>
                </li>
            </ul>
        </div>
        <div class="clearfix"></div>
        <div class="col-xs-6 col-sm-4 placeholder">
            <div class="input-group">
                <span class="input-group-addon">订单编号</span>
                <input id="searchKeyword" onkeyup="orderPage.onEnterKeyPress()" class="form-control"
                       data-toggle="tooltip" data-placement="bottom"
                       title="输入内容，点击键盘Enter查询"/>
            </div>
        </div>
        <div class="col-xs-6 col-sm-4 placeholder">
            <div class="input-group">
                <span class="input-group-addon">站点</span><select id="stationSelect"
                                                                 onchange="orderPage.refreshTableDatas();"
                                                                 class="form-control"></select>
            </div>
        </div>
    </div>

    <h2 class="sub-header">查询结果</h2>
    <div class="table-responsive">
        <table id="tableResult" data-pagination="true" data-side-pagination="server" data-striped="true"
               data-cache="false"
               data-unique-id="id" data-pagination-pre-text="上一页" data-pagination-next-text="下一页"></table>
    </div>
    <div class="modal fade" id="dispatchModal" role="dialog" aria-labelledby="myModalLabel">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span
                            aria-hidden="true">&times;</span></button>
                    <h4 class="modal-title" id="myModalLabel">订单派发【当前站点：<span id="currentStation"></span>】</h4>
                </div>
                <div class="modal-body">
                    <div class="table-responsive">
                        <table id="stationRiderResult" data-pagination="true" data-side-pagination="server"
                               data-striped="true" data-cache="false"
                               data-unique-id="id" data-pagination-pre-text="上一页"
                               data-pagination-next-text="下一页"></table>
                    </div>
                    <div id="dispatchMsg" style="display: none;" class="alert alert-danger" role="alert"></div>
                </div>
            </div>
        </div>
    </div>
</div>
<script>
    var orderPage = {};
    (function (page) {
        var _currentNewOrder = {};

        function initStations() {
            $.ajax({
                type: "get", url: "api/merchant/station/all",
                data: {pageNumber: 0, pageSize: 100}, async: false,
                success: function (result) {
                    var select = $("#stationSelect");
                    select.append('<option value="">全部</option>');
                    for (var i = 0; i < result.rows.length; i++) {
                        select.append('<option value="' + result.rows[i].id + '">' + result.rows[i].name + '</option>');
                    }
                }
            });
        }

        page.setStatusIndex = function (index) {
            page.selectOrderStatus(index);
        };

        page.onEnterKeyPress = function () {
            var code = event.charCode || event.keyCode;
            if (code == 13) {
                page.refreshTableDatas();
            }
        };

        page.selectOrderStatus = function (index) {
            var activeSelects = $("#activeSelect li");
            activeSelects.removeClass("active");
            activeSelects.eq(index).addClass("active");
            page.refreshTableDatas();
        };

        page.dispatch = function (id) {
            _currentNewOrder = $("#tableResult").bootstrapTable("getRowByUniqueId", id);
            $("#currentStation").html(_currentNewOrder.station.name);
            $("#dispatchModal").modal("show");
            initStationRiderTableDatas();
        };

        page.dispatchToRider = function (riderId) {
            $.ajax({
                type: "PUT", url: "api/merchant/order/dispatchToRider",
                data: {riderId: riderId, orderId: _currentNewOrder.id},
                success: function (result) {
                    if (result.status === SUCCESS) {
                        $("#dispatchModal").modal("hide");
                        page.refreshTableDatas();
                    } else {
                        $("#dispatchMsg").html(result.data).fadeIn(3000);
                        setTimeout(function () {
                            $("#dispatchMsg").fadeOut(1000);
                        }, 3000);
                    }
                }
            });
        };

        function initStationRiderTableDatas() {
            $('#stationRiderResult').bootstrapTable({
                url: 'api/merchant/rider/getRiderByStationId',
                method: "get",
                contentType: "application/x-www-form-urlencoded",
                queryParams: function (params) {
                    return {
                        pageSize: params.limit,
                        pageNumber: (params.offset / params.limit),
                        stationId: _currentNewOrder.station.id
                    };
                },
                columns: [
                    {
                        title: '序号', align: "center",
                        formatter: function (value, row, index) {
                            return index + 1;
                        }
                    },
                    {title: '骑手姓名', field: 'name',},
                    {title: '骑手手机号码', field: 'phoneNumber'},
                    {
                        title: '在途订单数量', field: 'orderIdsJson', formatter: function (value, row, index) {
                            return JSON.parse(row.orderIdsJson).length;
                        }
                    },
                    {
                        title: '操作', field: 'id', formatter: function (value, row, index) {
                            var html = "";
                            html += '<button type="button" class="btn btn-success" onclick="orderPage.dispatchToRider(' + value + ');"><span class="glyphicon glyphicon-send" aria-hidden="true"></span> 派单</button>&nbsp;';
                            return html;
                        }
                    }
                ]
            });
        };

        page.showDetail = function (id) {
            var currentData = $("#tableResult").bootstrapTable("getRowByUniqueId", id);
            indexPage.setContentBody("orderDetail.html", function (response, status, xhr) {
                orderDetailPage.initData(currentData);
            });
        };

        page.delete = function (id) {
            deleteConfirmModal.showModal();
            deleteConfirmModal.bindDeleteAction(deleteOrder, id);
        };

        function deleteOrder(id) {
            $.ajax({
                type: "DELETE", url: "api/merchant/order/" + id,
                data: {},
                success: function (result) {
                    if (result.status === SUCCESS) {
                        page.refreshTableDatas();
                    }
                }
            });
        }

        page.refreshTableDatas = function () {
            $('#tableResult').bootstrapTable("refresh", {silent: true});
        };

        function initTableDatas() {
            $('#tableResult').bootstrapTable({
                url: 'api/merchant/order/searchByParam',
                method: "get",
                contentType: "application/x-www-form-urlencoded",
                queryParams: function (params) {
                    return {
                        pageSize: params.limit, pageNumber: (params.offset / params.limit),
                        status: $("#activeSelect li[class='active']").attr("data-value"),
                        searchKeyword: $("#searchKeyword").val(), stationId: $("#stationSelect").val()
                    };
                },
                columns: [
                    {
                        title: '序号', align: "center",
                        formatter: function (value, row, index) {
                            return index + 1;
                        }
                    },
                    {title: '订单编号', field: 'serialNumber'},
                    {title: '站点', field: 'station.name'},
                    {title: '配送员', field: 'rider.name'},
                    {title: '配送员电话', field: 'rider.phoneNumber'},
                    {title: '收货人姓名', field: 'receiverName'},
                    {title: '收货人电话', field: 'receiverPhoneNumber'},
                    {title: '订单金额', field: 'paymentPrice'},
                    {title: '订单状态', field: 'status'},
                    {
                        title: '操作', field: 'id', formatter: function (value, row, index) {
                            var html = "";
                            if (row.status === "新订单") {
                                html = '<span style="cursor: pointer;color:#2F9D32;" onclick="orderPage.dispatch(' + value + ');">【派单】</span>';
                            }
                            html += '<span style="cursor: pointer;color:#2F9D32;" onclick="orderPage.showDetail(' + value + ');">【查看详情】</span>';
                            html += ' <span style="cursor: pointer;color:#2F9D32;" onclick="orderPage.delete(' + value + ');">【删除订单】</span>';
                            return html;
                        }
                    }
                ]
            });
        };

        function initOrderCount() {
            $.ajax({
                type: "get", url: "api/merchant/order/orderCount",
                data: {},
                success: function (result) {
                    $("#newCount").html(result.newCount);
                    $("#onGoingCount").html(result.onGoingCount);
                    $("#completedCount").html(result.completedCount);
                    $("#exceptionCount").html(result.exceptionCount);
                    $("#pressedCount").html(result.pressedCount);
                    $("#cancelCount").html(result.cancelCount);
                    $("#returnedCount").html(result.returnedCount);
                    $("#totalCount").html(result.totalCount);
                }
            });
        }

        $(function () {
            $("#searchKeyword").tooltip();
            initStations();
            initTableDatas();
            initOrderCount();
        });
    })(orderPage);
</script>