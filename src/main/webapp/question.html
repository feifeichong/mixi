<div class="col-sm-9 col-sm-offset-3 col-md-10 col-md-offset-2 main">
    <div class="title page-header">
        <h1>培训考试</h1>
    </div>
    <div class="row placeholders">
        <div class="col-xs-6 col-sm-3 placeholder">
            <div class="input-group">
                <span class="input-group-addon">题目名称</span>
                <input id="questionName" class="form-control"/>
            </div>
        </div>
        <div class="col-xs-6 col-sm-6 placeholder">
            <div class="input-group">
                <span class="input-group-addon">提交时间</span>
                <input id="beginTime" type="text" readonly style="cursor: pointer;" class="form-control"/>
                <span class="input-group-addon">至</span>
                <input id="endTime" type="text" readonly style="cursor: pointer;" class="form-control"/>
            </div>
        </div>
        <div class="col-xs-6 col-sm-1 placeholder">
            <button class="btn btn-success" onclick="questionPage.refreshTableDatas()">查询</button>
        </div>
    </div>
    <h4 class="left">数据列表</h4>
    <button class="btn btn-success right" onclick="indexPage.setContentBody('questionAdd.html')" type="button">新增</button>
    <button id="batchDeleteBtn" onclick="questionPage.deleteBatch();" class="btn btn-success right">批量删除</button>
    <div class="clearfix"></div>
    <div class="table-responsive">
        <table id="tableResult" data-pagination="true" data-side-pagination="server" data-striped="true" data-cache="false"
               data-unique-id="id" data-pagination-pre-text="上一页" data-pagination-next-text="下一页"></table>
    </div>
</div>
<script>
    var questionPage = {};
    (function (page) {
        page.onEnterKeyPress = function () {
            var code = event.charCode || event.keyCode;
            if (code == 13) {
                page.refreshTableDatas();
            }
        };

        page.onTimeChanged = function () {
            page.refreshTableDatas();
        };

        page.edit = function (id) {
            var currentData = $("#tableResult").bootstrapTable("getRowByUniqueId", id);
            indexPage.setContentBody("questionUpdate.html", function (response, status, xhr) {
                questionUpdatePage.setData(currentData);
            });
        };

        page.delete = function (id) {
            deleteConfirmModal.showModal();
            deleteConfirmModal.bindDeleteAction(deleteById, id);
        };

        function deleteById(id) {
            $.ajax({
                type: "DELETE", url: "api/merchant/question/" + id,
                data: {},
                success: function (result) {
                    if (result.status === SUCCESS) {
                        page.refreshTableDatas();
                    }
                }
            });
        }

        page.deleteBatchAction = function (ids) {
            $.ajax({
                type: "POST", url: "/api/merchant/question/deleteBatch",
                contentType: "application/json",
                data: JSON.stringify(ids),
                success: function (result) {
                    if (result.status === SUCCESS)
                        page.refreshTableDatas();
                }
            });
        };

        page.deleteBatch = function () {
            var selectedRows = $("#tableResult").bootstrapTable('getSelections');
            if (selectedRows.length === 0) {
                commonModal.showModal("请勾选数据进行批量删除");
            } else {
                var ids = [];
                for (var i = 0; i < selectedRows.length; i++) {
                    ids.push(selectedRows[i].id);
                }
                deleteConfirmModal.showModal();
                deleteConfirmModal.bindDeleteAction(page.deleteBatchAction, ids);
            }
        };

        page.refreshTableDatas = function () {
            $('#tableResult').bootstrapTable("refresh", {silent: true});
        };

        var optionHeaders = ["A", "B", "C", "D"];

        function initTableDatas() {
            $('#tableResult').bootstrapTable({
                url: 'api/merchant/question/searchForConsole',
                method: "get",
                contentType: "application/x-www-form-urlencoded",
                queryParams: function (params) {
                    return {
                        pageSize: params.limit, pageNumber: (params.offset / params.limit),
                        name: $("#questionName").val(), beginTime: $("#beginTime").val(), endTime: $("#endTime").val()
                    };
                },
                columns: [
                    {
                        field: 'checked',
                        checkbox: true
                    },
                    {
                        title: '序号', align: "center",
                        formatter: function (value, row, index) {
                            return index + 1;
                        }
                    },
                    {title: '题目', field: 'name'},
                    {
                        title: '选项', field: 'options', formatter: function (value, row, index) {
                            var items = JSON.parse(row.options);
                            var html = "";
                            for (var i = 0; i < items.length; i++) {
                                html += optionHeaders[i] + ". " + items[i] + "&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;";
                            }
                            return html;
                        }
                    },
                    {
                        title: '答案', field: 'answer', formatter: function (value, row, index) {
                            var item = JSON.parse(row.answer);
                            return item.join(",");
                        }
                    },
                    {title: '提交时间', field: 'creationTime'},
                    {
                        title: '操作', field: 'id', formatter: function (value, row, index) {
                            var html = '<span style="cursor: pointer;color:#2F9D32;" onclick="questionPage.edit(' + value + ');">【修改】</span>';
                            html += ' <span style="cursor: pointer;color:#2F9D32;" onclick="questionPage.delete(' + value + ');">【删除】</span>';
                            return html;
                        }
                    }
                ]
            });
        };

        $(function () {
            $("#questionName").tooltip();

            $('#beginTime').datetimepicker({
                format: 'yyyy-mm-dd', minView: 2, autoclose: true, todayBtn: true, language: "zh-CN"
            });
            $('#endTime').datetimepicker({
                format: 'yyyy-mm-dd', minView: 2, autoclose: true, todayBtn: true, language: "zh-CN"
            });

            initTableDatas();
        });
    })(questionPage);
</script>